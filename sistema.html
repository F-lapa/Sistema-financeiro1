<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Receitas e Despesas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css"> <!-- Referência ao arquivo CSS externo -->
</head>
<body>
   <div class="container">
        <div class="greeting" id="userGreeting"></div>
        <h1>Sistema de Receitas e Despesas</h1>
        <i class="fas fa-sign-out-alt logout" onclick="logout()" title="Deslogar"></i>
        <i class="fas fa-user-shield admin-icon" id="adminIcon" onclick="toggleAdminSection()" title="Admin"></i>
        <div class="form-group">
            <label for="date">Data:</label>
            <input type="date" id="date" onchange="updateFilteredView()" class="highlight">
        </div>
        <div class="form-group">
            <label for="description">Descrição:</label>
            <input type="text" id="description" class="highlight">
        </div>
        <div class="form-group">
            <label for="amount">Valor (R$):</label>
            <input type="text" id="amount" placeholder="0,00" pattern="^\d+(\.\d{1,2})?$" title="Digite um valor válido" class="highlight" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="type">Tipo:</label>
            <select id="type" class="highlight">
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
            </select>
        </div>
        <div class="buttons">
            <button onclick="addTransaction()">Adicionar</button>
        </div>

        <table id="transactionsTable">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Valor</th>
                    <th>Tipo</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                <!-- Transactions will be added here -->
            </tbody>
        </table>

        <div class="totals">
            <p>Saldo do Dia: <span id="dailyBalance">R$ 0,00</span></p>
            <p>Saldo do Mês: <span id="monthlyBalance">R$ 0,00</span></p>
            <p>Saldo do Ano: <span id="annualBalance">R$ 0,00</span></p>
        </div>

        <div class="filter">
            <h2>Filtrar por Período</h2>
            <div class="date-group">
                <div class="form-group">
                    <label for="startDate">Data Inicial:</label>
                    <input type="date" id="startDate" class="highlight">
                </div>
                <div class="form-group">
                    <label for="endDate">Data Final:</label>
                    <input type="date" id="endDate" class="highlight">
                </div>
            </div>
            <div class="form-group">
                <label for="filterType">Tipo:</label>
                <select id="filterType" class="highlight">
                    <option value="">Todos</option>
                    <option value="receita">Receita</option>
                    <option value="despesa">Despesa</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filterDescription">Descrição:</label>
                <select id="filterDescription" class="highlight">
                    <option value="">Todos</option>
                    <!-- Options will be populated here -->
                </select>
            </div>
            <button onclick="filterByPeriod()">Filtrar</button>
            <button onclick="clearFilter()">Limpar Filtro</button>
            <div id="filteredResults">
                <p>Total Receitas: <span id="totalReceitas">R$ 0,00</span></p>
                <p>Total Despesas: <span id="totalDespesas" class="negative">R$ 0,00</span></p>
                <p>Saldo: <span id="totalSaldo">R$ 0,00</span></p>
            </div>
            <div class="filter-results" id="filterResults">
                <h3>Extrato</h3>
                <table id="filteredTransactionsTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Valor</th>
                            <th>Tipo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filtered transactions will be added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="admin-section" id="adminSection">
            <h2>Gerenciamento de Usuários</h2>
            <div class="form-group">
                <label for="newUserName">Nome do Novo Usuário:</label>
                <input type="text" id="newUserName" class="highlight">
            </div>
            <div class="form-group">
                <label for="newUserEmail">Email do Novo Usuário:</label>
                <input type="text" id="newUserEmail" class="highlight">
            </div>
            <div class="form-group">
                <label for="newUserPassword">Senha do Novo Usuário:</label>
                <input type="password" id="newUserPassword" class="highlight">
            </div>
            <div class="form-group">
                <label for="userSelect">Selecionar Usuário:</label>
                <select id="userSelect" class="highlight">
                    <!-- Options will be populated here -->
                </select>
            </div>
            <div class="buttons">
                <button onclick="registerNewUser()">Registrar Novo Usuário</button>
                <button onclick="clearAllTransactions()">Limpar Minhas Transações</button>
                <button onclick="adminUndoLastTransaction()">Corrigir Última Ação do Usuário</button>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>

    <script>
        // Configuração do Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyDgTFBPipaSGqJlahiT-THgzBH4JKuQSA4",
            authDomain: "sistema-de-receitas-e-despesas.firebaseapp.com",
            databaseURL: "https://sistema-de-receitas-e-despesas-default-rtdb.firebaseio.com",
            projectId: "sistema-de-receitas-e-despesas",
            storageBucket: "sistema-de-receitas-e-despesas.appspot.com",
            messagingSenderId: "252102478972",
            appId: "1:252102478972:web:c7e9e4c25b3bc7c6c50df9",
            measurementId: "G-K2HCS7WNZV"
        };
        // Inicialize o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Verifique se o usuário está autenticado
        auth.onAuthStateChanged(user => {
    if (user) {
        const userId = user.uid;
        database.ref('users/' + userId).once('value').then((snapshot) => {
            const userData = snapshot.val();
            const userName = userData ? userData.name : "Usuário";
            localStorage.setItem('username', userName);
            document.getElementById('userGreeting').innerHTML = user.email === 'fernandolapa1987@gmail.com' ? 
                '<span>Olá, <strong>Administrador!</strong></span>' : 
                '<span>Olá, <strong>' + userName + '</strong>!</span>';
            loadTransactions();
            checkAdmin(user.email);
        });
    } else {
        window.location.href = 'index.html';  // Redirecionar para a página de login se não estiver autenticado
    }
});

let transactions = [];
let lastTransactionId = localStorage.getItem('lastTransactionId');
let allUsers = [];

function saveTransactions() {
    const userId = auth.currentUser.uid;
    database.ref('transactions/' + userId).set(transactions);
}

function loadTransactions() {
    const userId = auth.currentUser.uid;
    database.ref('transactions/' + userId).once('value', function(snapshot) {
        if (snapshot.val()) {
            transactions = snapshot.val();
            updateDescriptionList();
            updateFilteredView();
            calculateBalances();
        }
    });
}

function checkAdmin(email) {
    if (email === 'fernandolapa1987@gmail.com') {
        document.getElementById('adminIcon').style.display = 'block';
        loadAllUsers();
    }
}

function loadAllUsers() {
    database.ref('users').once('value').then((snapshot) => {
        const users = snapshot.val();
        const userSelect = document.getElementById('userSelect');
        userSelect.innerHTML = '';
        for (let uid in users) {
            allUsers.push({ uid, name: users[uid].name });
            const option = document.createElement('option');
            option.value = uid;
            option.textContent = users[uid].name;
            userSelect.appendChild(option);
        }
    });
}

function formatCurrency(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function parseCurrency(value) {
    return parseFloat(value.replace(/\./g, '').replace(',', '.').replace('R$', '')) || 0;
}

function addTransaction() {
    console.log('Adicionar Transação');
    const date = document.getElementById('date').value;
    const description = document.getElementById('description').value;
    const amountInput = document.getElementById('amount');
    const amount = parseCurrency(amountInput.value);
    const type = document.getElementById('type').value;

    const transaction = { id: generateTransactionId(), date, description, amount, type };
    transactions.push(transaction);
    lastTransactionId = transaction.id;
    localStorage.setItem('lastTransactionId', lastTransactionId);

    saveTransactions();
    updateDescriptionList();
    updateFilteredView();
    calculateBalances();

    // Reset form fields
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    document.getElementById('description').value = '';
    amountInput.value = '0,00';
    document.getElementById('type').value = 'receita';
}

function generateTransactionId() {
    return '_' + Math.random().toString(36).substr(2, 9);
}

function updateDescriptionList() {
    const filterDescription = document.getElementById('filterDescription');
    filterDescription.innerHTML = '<option value="">Todos</option>';
    const uniqueDescriptions = [...new Set(transactions.map(t => t.description))];
    uniqueDescriptions.forEach(description => {
        const option = document.createElement('option');
        option.value = description;
        option.text = description;
        filterDescription.appendChild(option);
    });
}

function updateFilteredView() {
    const selectedDate = document.getElementById('date').value;
    const tbody = document.getElementById('transactionsTable').getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';

    transactions.forEach(transaction => {
        if (transaction.date === selectedDate) {
            const row = tbody.insertRow();
            const cellDate = row.insertCell(0);
            const cellDescription = row.insertCell(1);
            const cellAmount = row.insertCell(2);
            const cellType = row.insertCell(3);
            const cellAction = row.insertCell(4); // Nova célula para o ícone de remoção

            cellDate.innerText = transaction.date;
            cellDescription.innerHTML = `<div class="transaction-description">
                                            <i class="transaction-icon ${transaction.type === 'receita' ? 'fas fa-arrow-circle-up' : 'fas fa-arrow-circle-down'}" style="color: ${transaction.type === 'receita' ? 'green' : 'red'};"></i>
                                            ${transaction.description}
                                         </div>`;
            cellAmount.innerHTML = `<div class="transaction-amount ${transaction.type}">${formatCurrency(transaction.amount)}</div>`;
            cellType.innerText = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1);
            cellAction.innerHTML = `<i class="fas fa-trash-alt" onclick="confirmRemoveTransaction('${transaction.id}')" style="cursor:pointer; color:red;"></i>`;
        }
    });

    calculateBalances();
}

function confirmRemoveTransaction(transactionId) {
    if (confirm('Tem certeza que deseja remover esta transação?')) {
        removeTransaction(transactionId);
    }
}

function removeTransaction(transactionId) {
    transactions = transactions.filter(transaction => transaction.id !== transactionId);
    saveTransactions();
    updateDescriptionList();
    updateFilteredView();
    calculateBalances();
}

function calculateBalances() {
    const selectedDate = document.getElementById('date').value;
    const currentMonth = selectedDate.slice(0, 7);
    const currentYear = selectedDate.slice(0, 4);

    let dailyBalance = 0;
    let monthlyBalance = 0;
    let annualBalance = 0;

    transactions.forEach(transaction => {
        if (transaction.date === selectedDate) {
            dailyBalance += transaction.type === 'receita' ? transaction.amount : -transaction.amount;
        }

        if (transaction.date.startsWith(currentMonth)) {
            monthlyBalance += transaction.type === 'receita' ? transaction.amount : -transaction.amount;
        }

        if (transaction.date.startsWith(currentYear)) {
            annualBalance += transaction.type === 'receita' ? transaction.amount : -transaction.amount;
        }
    });

    const dailyBalanceSpan = document.getElementById('dailyBalance');
    const monthlyBalanceSpan = document.getElementById('monthlyBalance');
    const annualBalanceSpan = document.getElementById('annualBalance');

    dailyBalanceSpan.innerText = formatCurrency(dailyBalance);
    monthlyBalanceSpan.innerText = formatCurrency(monthlyBalance);
    annualBalanceSpan.innerText = formatCurrency(annualBalance);

    dailyBalanceSpan.classList.toggle('negative', dailyBalance < 0);
    monthlyBalanceSpan.classList.toggle('negative', monthlyBalance < 0);
    annualBalanceSpan.classList.toggle('negative', annualBalance < 0);
}

function filterByPeriod() {
    console.log('Filtrar por Período');
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const filterType = document.getElementById('filterType').value;
    const filterDescription = document.getElementById('filterDescription').value.toLowerCase();

    let totalReceitas = 0;
    let totalDespesas = 0;

    const filteredTransactions = transactions.filter(transaction => 
        transaction.date >= startDate && transaction.date <= endDate &&
        (filterType === '' || transaction.type === filterType) &&
        (filterDescription === '' || transaction.description.toLowerCase().includes(filterDescription))
    );

    const filteredTbody = document.getElementById('filteredTransactionsTable').getElementsByTagName('tbody')[0];
    filteredTbody.innerHTML = '';

    filteredTransactions.forEach(transaction => {
        if (transaction.type === 'receita') {
            totalReceitas += transaction.amount;
        } else if (transaction.type === 'despesa') {
            totalDespesas += transaction.amount;
        }

        const row = filteredTbody.insertRow();
        const cellDate = row.insertCell(0);
        const cellDescription = row.insertCell(1);
        const cellAmount = row.insertCell(2);
        const cellType = row.insertCell(3);

        cellDate.innerText = transaction.date;
        cellDescription.innerHTML = `<div class="transaction-description">
                                        <i class="transaction-icon ${transaction.type === 'receita' ? 'fas fa-arrow-circle-up' : 'fas fa-arrow-circle-down'}" style="color: ${transaction.type === 'receita' ? 'green' : 'red'};"></i>
                                        ${transaction.description}
                                     </div>`;
        cellAmount.innerHTML = `<div class="transaction-amount ${transaction.type}">${formatCurrency(transaction.amount)}</div>`;
        cellType.innerText = transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1);
    });

    const totalSaldo = totalReceitas - totalDespesas;

    const totalReceitasSpan = document.getElementById('totalReceitas');
    const totalDespesasSpan = document.getElementById('totalDespesas');
    const totalSaldoSpan = document.getElementById('totalSaldo');

    totalReceitasSpan.innerText = formatCurrency(totalReceitas);
    totalDespesasSpan.innerText = formatCurrency(totalDespesas);
    totalSaldoSpan.innerText = formatCurrency(totalSaldo);

    totalDespesasSpan.classList.add('negative');
    totalSaldoSpan.classList.toggle('negative', totalSaldo < 0);
}

function clearFilter() {
    console.log('Limpar Filtro');
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterDescription').value = '';
    document.getElementById('filteredTransactionsTable').getElementsByTagName('tbody')[0].innerHTML = '';
    document.getElementById('totalReceitas').innerText = 'R$ 0,00';
    document.getElementById('totalDespesas').innerText = 'R$ 0,00';
    document.getElementById('totalSaldo').innerText = 'R$ 0,00';
}

const inputs = document.querySelectorAll('input, select');
inputs.forEach(input => {
    input.addEventListener('focus', function() {
        this.classList.remove('highlight');
    });
});

const amountInput = document.getElementById('amount');
amountInput.addEventListener('input', function() {
    this.value = this.value.replace(/[^\d,]/g, '');
});

amountInput.addEventListener('blur', function() {
    if (this.value === '') {
        this.value = '0,00';
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    dateInput.value = new Date().toISOString().split('T')[0];
});

function logout() {
    console.log('Logout');
    auth.signOut().then(() => {
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('username');
        localStorage.removeItem('lastTransactionId');
        window.location.href = 'index.html';
    }).catch(error => {
        console.error('Erro ao deslogar: ', error);
    });
}

function toggleAdminSection() {
    console.log('Toggle Admin Section');
    const adminSection = document.getElementById('adminSection');
    adminSection.style.display = adminSection.style.display === 'block' ? 'none' : 'block';
}

function clearAllTransactions() {
    console.log('Limpar Todas as Transações');
    if (confirm('Você tem certeza que deseja limpar todas as suas transações?')) {
        const userId = auth.currentUser.uid;
        database.ref('transactions/' + userId).remove().then(() => {
            transactions = [];
            updateDescriptionList();
            updateFilteredView();
            calculateBalances();
            alert('Todas as suas transações foram removidas.');
        }).catch(error => {
            alert('Erro ao remover transações: ' + error.message);
        });
    }
}

function registerNewUser() {
    console.log('Registrar Novo Usuário');
    const name = document.getElementById('newUserName').value;
    const email = document.getElementById('newUserEmail').value;
    const password = document.getElementById('newUserPassword').value;

    auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
            const user = userCredential.user;
            database.ref('users/' + user.uid).set({
                name: name,
                email: email
            }).then(() => {
                alert('Novo usuário registrado com sucesso.');
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                loadAllUsers(); // Atualiza a lista de usuários após registrar um novo usuário
            });
        })
        .catch(error => {
            alert('Erro ao registrar novo usuário: ' + error.message);
        });
}

function adminUndoLastTransaction() {
    console.log('Corrigir Última Ação do Usuário');
    if (lastTransactionId) {
        transactions = transactions.filter(transaction => transaction.id !== lastTransactionId);
        saveTransactions();
        updateDescriptionList();
        updateFilteredView();
        calculateBalances();
        alert('Última ação do usuário foi corrigida.');
        lastTransactionId = null;
        localStorage.removeItem('lastTransactionId');
    } else {
        alert('Nenhuma ação anterior para corrigir.');
    }
}

    </script>
</body>
</html>
